title:	Fix test execution environment
state:	OPEN
author:	baldawsari
labels:	bug, enhancement, high-priority, testing
comments:	0
assignees:	
projects:	
milestone:	
number:	20
--
## Problem
After merging PR #19 with comprehensive test coverage, the test suite has execution issues that need to be resolved. The test code itself is valuable and correct, but the environment needs fixes.

## Root Causes Identified
1. **Mock initialization order** - Mocks need to be cleared/reset before imports
2. **Missing middleware** - errorHandling.js middleware is missing
3. **Browser globals** - Some tests expect browser environment (FormData, etc.)
4. **Supabase mock chains** - Inconsistent mock return values for chained methods

## Implementation Plan

### Phase 1: Environment Setup (2 hours)
```bash
# Fix mock initialization order
echo "jest.resetModules();" >> jest.setup.js

# Create missing middleware
mkdir -p src/middleware
# Create errorHandling.js with proper error handler

# Install browser environment
npm install --save-dev jest-environment-jsdom
```

### Phase 2: Test File Fixes (2-4 hours)
1. **Mock Timing Issues** (28 files)
   - Add `beforeAll(() => { jest.clearAllMocks(); })`
   - Move mock definitions before imports

2. **Supabase Chain Issues** (15 files)
   - Create shared mock helper: `tests/helpers/supabaseMock.js`
   - Standardize chain method returns

3. **Browser Global Issues** (8 files)
   - Add `@jest-environment jsdom` comment to affected files
   - Or refactor to remove browser dependencies

### Phase 3: Validation
```bash
# Run tests in groups to isolate issues
npm test -- tests/unit/services --runInBand
npm test -- tests/unit/utils --runInBand
npm test -- tests/integration --runInBand
```

## Success Criteria
- [ ] All 652 tests passing
- [ ] CI/CD pipeline fully green
- [ ] Test execution time < 30 seconds
- [ ] No flaky tests
- [ ] Remove `--passWithNoTests` flag
- [ ] Set `ENABLE_FULL_TEST_SUITE=true`

## Affected Files
- `jest.config.js` - Remove passWithNoTests
- `jest.setup.js` - Add module reset
- `src/middleware/errorHandling.js` - Create file
- Multiple test files for mock fixes

## Time Estimate
4-6 hours total

## References
- PR #19: Comprehensive test coverage implementation
- TEST_FIX_PLAN.md: Detailed analysis and strategy
